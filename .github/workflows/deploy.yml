name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ”„ Starting deployment..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/service_project
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
            echo "ğŸ—ï¸ Building frontend..."
            yarn install --frozen-lockfile
            yarn build
            
            # ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing backend dependencies..."
            cd backend
            yarn install --frozen-lockfile
            
            # Prisma í´ë¼ì´ì–¸íŠ¸ ì¬ìƒì„±
            echo "ğŸ—„ï¸ Generating Prisma client..."
            yarn prisma generate
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
            echo "ğŸ”„ Restarting applications..."
            cd ~/service_project
            pm2 restart frontend || pm2 start yarn --name "frontend" -- start
            
            cd backend
            pm2 restart backend || pm2 start server.js --name "backend"
            
            # ìƒíƒœ í™•ì¸
            echo "âœ… Deployment completed!"
            pm2 status

